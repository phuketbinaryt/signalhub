datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Trade {
  id           Int           @id @default(autoincrement())
  ticker       String
  direction    String        // "long" or "short"
  entryPrice   Float
  takeProfit   Float?
  stopLoss     Float?
  quantity     Float         @default(1.0)
  strategy     String?       // Strategy name from TradingView
  status       String        @default("open") // "open" | "closed"
  openedAt     DateTime      @default(now())
  closedAt     DateTime?
  exitPrice    Float?
  exitReason   String?       // "take_profit" | "stop_loss" | "manual" | other
  pnl          Float?        // profit/loss in points or currency
  pnlPercent   Float?        // percentage P&L

  events       TradeEvent[]

  @@index([ticker])
  @@index([status])
  @@index([openedAt])
}

model TradeEvent {
  id         Int       @id @default(autoincrement())
  trade      Trade     @relation(fields: [tradeId], references: [id], onDelete: Cascade)
  tradeId    Int
  eventType  String    // "entry" | "take_profit" | "stop_loss"
  price      Float
  createdAt  DateTime  @default(now())
  rawPayload Json      // store original webhook body

  @@index([tradeId])
  @@index([eventType])
}

model PushSubscription {
  id         Int       @id @default(autoincrement())
  endpoint   String    @unique
  p256dh     String    // Public key for encryption
  auth       String    // Auth secret for encryption
  userAgent  String?   // Optional: track device type
  createdAt  DateTime  @default(now())
  lastUsed   DateTime  @default(now())

  @@index([endpoint])
}

model Settings {
  id                      Int      @id @default(autoincrement())
  key                     String   @unique
  value                   Json     // Store settings as JSON
  updatedAt               DateTime @default(now()) @updatedAt

  @@index([key])
}

model PickMyTradeConfig {
  id              Int      @id @default(autoincrement())
  name            String   // User-friendly name for this config
  enabled         Boolean  @default(true)
  webhookUrls     Json     // Array of webhook URLs
  allowedTickers  Json     // Array of allowed tickers
  token           String
  accountId       String
  riskPercentage  Float    @default(100) // Percentage of original quantity (100 = full size)
  roundingMode    String   @default("down") // "up" or "down" for fractional quantities
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([enabled])
}
